import sqlite3
from math import radians, cos, sin, sqrt, atan2
from telegram import Update, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

BOT_TOKEN = "8310551533:AAHdAP2ypXbq2ilGnTJWaZHO4Scq6OYwYDo"

LANGS = ['uk', 'en']

TEXTS = {
    'start': {
        'uk': "ĞŸÑ€Ğ¸Ğ²Ñ–Ñ‚! Ğ¯ Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ ÑÑ‚Ğ°Ğ½Ñƒ Ğ·Ğ°Ğ»Ñ–Ğ·Ğ½Ğ¸Ñ‡Ğ½Ğ¸Ñ… Ğ¿ĞµÑ€ĞµÑ—Ğ·Ğ´Ñ–Ğ² ğŸš‚",
        'en': "Hi! I'm a bot to check railway crossing status ğŸš‚"
    },
    'menu': {
        'uk': "ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¾Ğ¿Ñ†Ñ–Ñ:",
        'en': "Choose an option:"
    },
    'nearest': {
        'uk': "ğŸ“ Ğ—Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ½Ğ°Ğ¹Ğ±Ğ»Ğ¸Ğ¶Ñ‡Ğ¸Ğ¹ Ğ¿ĞµÑ€ĞµÑ—Ğ·Ğ´",
        'en': "ğŸ“ Find nearest crossing"
    },
    'by_region': {
        'uk': "ğŸ“‹ ĞŸĞµÑ€ĞµÑ—Ğ·Ğ´Ğ¸ Ğ¿Ğ¾ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚Ñ–",
        'en': "ğŸ“‹ Crossings by region"
    },
    'change_lang': {
        'uk': "ğŸŒ Ğ—Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸ Ğ¼Ğ¾Ğ²Ñƒ",
        'en': "ğŸŒ Change language"
    },
    'send_location': {
        'uk': "Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ½Ğ°Ğ´Ñ–ÑˆĞ»Ñ–Ñ‚ÑŒ ÑĞ²Ğ¾Ñ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ñ–Ñ ğŸŒ",
        'en': "Please send your location ğŸŒ"
    },
    'found': {
        'uk': "ĞĞ°Ğ¹Ğ±Ğ»Ğ¸Ğ¶Ñ‡Ğ¸Ğ¹ Ğ¿ĞµÑ€ĞµÑ—Ğ·Ğ´:",
        'en': "Nearest crossing:"
    },
    'switched': {
        'uk': "ĞœĞ¾Ğ²Ñƒ Ğ·Ğ¼Ñ–Ğ½ĞµĞ½Ğ¾ Ğ½Ğ° ÑƒĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºÑƒ ğŸ‡ºğŸ‡¦",
        'en': "Language switched to English ğŸ‡¬ğŸ‡§"
    }
}

user_langs = {}

def get_text(key, lang):
    return TEXTS.get(key, {}).get(lang, TEXTS[key]['en'])

def haversine(lat1, lon1, lat2, lon2):
    R = 6371
    dlat = radians(lat2 - lat1)
    dlon = radians(lon2 - lon1)
    a = sin(dlat/2)**2 + cos(radians(lat1)) * cos(radians(lat2)) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1 - a))
    return R * c

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_langs[user_id] = 'uk'
    lang = user_langs[user_id]
    buttons = [
        [KeyboardButton(get_text('nearest', lang), request_location=True)],
        [get_text('by_region', lang)],
        [get_text('change_lang', lang)]
    ]
    markup = ReplyKeyboardMarkup(buttons, resize_keyboard=True)
    await update.message.reply_text(
        get_text('start', lang) + "\n" + get_text('menu', lang),
        reply_markup=markup
    )

async def handle_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    lang = user_langs.get(user_id, 'uk')
    user_loc = update.message.location
    conn = sqlite3.connect("database.db")
    cursor = conn.cursor()
    cursor.execute("SELECT name, latitude, longitude, status FROM crossings")
    crossings = cursor.fetchall()
    conn.close()
    nearest = None
    min_dist = float('inf')
    for name, lat, lon, status in crossings:
        dist = haversine(user_loc.latitude, user_loc.longitude, lat, lon)
        if dist < min_dist:
            min_dist = dist
            nearest = (name, status, dist)
    if nearest:
        msg = f"{get_text('found', lang)} {nearest[0]} ({nearest[1]}), ~{nearest[2]:.1f} km"
    else:
        msg = "Not found"
    await update.message.reply_text(msg)

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    lang = user_langs.get(user_id, 'uk')
    text = update.message.text

    if text == get_text('by_region', lang):
        await update.message.reply_text("Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ² Ñ€Ğ¾Ğ·Ñ€Ğ¾Ğ±Ñ†Ñ– / Feature in development")
    elif text == get_text('change_lang', lang):
        new_lang = 'en' if lang == 'uk' else 'uk'
        user_langs[user_id] = new_lang
        buttons = [
            [KeyboardButton(get_text('nearest', new_lang), request_location=True)],
            [get_text('by_region', new_lang)],
            [get_text('change_lang', new_lang)]
        ]
        markup = ReplyKeyboardMarkup(buttons, resize_keyboard=True)
        await update.message.reply_text(get_text('switched', new_lang), reply_markup=markup)
    else:
        await update.message.reply_text(get_text('send_location', lang))

def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.LOCATION, handle_location))
    app.add_handler(MessageHandler(filters.TEXT, handle_text))
    print("Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ ğŸš€")
    app.run_polling()

if __name__ == "__main__":
    main()