import sqlite3
import os
from math import radians, cos, sin, sqrt, atan2
from telegram import Update, KeyboardButton, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ –æ—Å—Ç–∞–≤–∏–º —Ç–∞–∫:
BOT_TOKEN = "8310551533:AAHdAP2ypXbq2ilGnTJWaZHO4Scq6OYwYDo"

TEXTS = {
    'start': {
        'uk': "–ü—Ä–∏–≤—ñ—Ç! –Ø –±–æ—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É –∑–∞–ª—ñ–∑–Ω–∏—á–Ω–∏—Ö –ø–µ—Ä–µ—ó–∑–¥—ñ–≤ üöÇ",
        'en': "Hi! I'm a bot to check railway crossing status üöÇ"
    },
    'menu': {
        'uk': "–û–±–µ—Ä—ñ—Ç—å –æ–ø—Ü—ñ—é:",
        'en': "Choose an option:"
    },
    'nearest': {
        'uk': "üìç –ó–Ω–∞–π—Ç–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–π –ø–µ—Ä–µ—ó–∑–¥",
        'en': "üìç Find nearest crossing"
    },
    'by_region': {
        'uk': "üìã –ü–µ—Ä–µ—ó–∑–¥–∏ –ø–æ –æ–±–ª–∞—Å—Ç—ñ",
        'en': "üìã Crossings by region"
    },
    'change_lang': {
        'uk': "üåê –ó–º—ñ–Ω–∏—Ç–∏ –º–æ–≤—É",
        'en': "üåê Change language"
    },
    'send_location': {
        'uk': "–ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Å–≤–æ—é –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é üåç",
        'en': "Please send your location üåç"
    },
    'found': {
        'uk': "–ù–∞–π–±–ª–∏–∂—á–∏–π –ø–µ—Ä–µ—ó–∑–¥:",
        'en': "Nearest crossing:"
    },
    'switched': {
        'uk': "–ú–æ–≤—É –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É üá∫üá¶",
        'en': "Language switched to English üá¨üáß"
    }
}

user_langs = {}  # —Ö—Ä–∞–Ω–∏—Ç —è–∑—ã–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è


def get_text(key, lang):
    return TEXTS[key].get(lang, TEXTS[key]['en'])


def haversine(lat1, lon1, lat2, lon2):
    R = 6371
    dlat = radians(lat2 - lat1)
    dlon = radians(lon2 - lon1)
    a = sin(dlat/2)**2 + cos(radians(lat1)) * cos(radians(lat2)) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1 - a))
    return R * c


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    user_langs[user_id] = 'uk'  # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–∫—Ä
    lang = user_langs[user_id]

    buttons = [
        [KeyboardButton(get_text('nearest', lang), request_location=True)],
        [get_text('by_region', lang)],
        [get_text('change_lang', lang)]
    ]
    markup = ReplyKeyboardMarkup(buttons, resize_keyboard=True)
    await update.message.reply_text(
        get_text('start', lang) + "\n" + get_text('menu', lang),
        reply_markup=markup
    )


async def handle_location(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    lang = user_langs.get(user_id, 'uk')
    user_loc = update.message.location

    try:
        conn = sqlite3.connect("database.db")
        cursor = conn.cursor()
        cursor.execute("SELECT name, latitude, longitude, status FROM crossings")
        crossings = cursor.fetchall()
        conn.close()

        if not crossings:
            await update.message.reply_text("–£ –±–∞–∑—ñ –Ω–µ–º–∞—î –ø–µ—Ä–µ—ó–∑–¥—ñ–≤ / No crossings in database")
            return

        nearest = None
        min_dist = float('inf')
        for name, lat, lon, status in crossings:
            dist = haversine(user_loc.latitude, user_loc.longitude, lat, lon)
            if dist < min_dist:
                min_dist = dist
                nearest = (name, status, dist)

        if nearest:
            msg = f"{get_text('found', lang)} {nearest[0]} ({nearest[1]}), ~{nearest[2]:.1f} km"
        else:
            msg = "Not found"
        await update.message.reply_text(msg)

    except Exception as e:
        await update.message.reply_text(f"Error: {e}")


async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    lang = user_langs.get(user_id, 'uk')
    text = update.message.text

    if text == get_text('by_region', lang):
        await update.message.reply_text("–§—É–Ω–∫—Ü—ñ—è –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ / Feature in development")
    elif text == get_text('change_lang', lang):
        new_lang = 'en' if lang == 'uk' else 'uk'
        user_langs[user_id] = new_lang
        buttons = [
            [KeyboardButton(get_text('nearest', new_lang), request_location=True)],
            [get_text('by_region', new_lang)],
            [get_text('change_lang', new_lang)]
        ]
        markup = ReplyKeyboardMarkup(buttons, resize_keyboard=True)
        await update.message.reply_text(get_text('switched', new_lang), reply_markup=markup)
    else:
        await update.message.reply_text(get_text('send_location', lang))


def main():
    app = Application.builder().token(BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.LOCATION, handle_location))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω üöÄ")
    app.run_polling()


if __name__ == "__main__":
    main()